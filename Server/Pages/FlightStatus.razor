@page "/flightstatus"
@using Microsoft.AspNetCore.SignalR.Client
@using Data.Models

<h3>Нислэгийн төлөв</h3>

@if (flights == null)
{
    <p>Уншиж байна...</p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Нислэгийн дугаар</th>
                <th>Эхлэх</th>
                <th>Очих</th>
                <th>Төлөв</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var flight in flights)
            {
                <tr>
                    <td>@flight.FlightNumber</td>
                    <td>@flight.Departure</td>
                    <td>@flight.Arrival</td>
                    <td>@flight.Status.ToString()</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<Flight> flights;
    private HubConnection hubConnection;

    protected override async Task OnInitializedAsync()
    {
        // Нислэгийн жагсаалтыг API эсвэл service-ээс авна
        flights = await FlightService.GetAllFlightsAsync(); // энэ нь таны service-ийн wrapper гэж үзнэ

        // SignalR холболт үүсгэх
        hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/flightstatushub"))
            .WithAutomaticReconnect()
            .Build();

        // 🟢 SignalR эвент бүртгэх
        hubConnection.On<int, string>("FlightStatusChanged", (flightId, newStatus) =>
        {
            var flight = flights.FirstOrDefault(f => f.FlightId == flightId);
            if (flight != null)
            {
                flight.Status = Enum.Parse<FlightStatus>(newStatus);
                InvokeAsync(StateHasChanged); // UI-г шинэчлэх
            }
        });

        await hubConnection.StartAsync();
    }

    // 🛑 Component-оос гарахад холболтыг зогсоох
    public async ValueTask DisposeAsync()
    {
        if (hubConnection != null)
        {
            await hubConnection.DisposeAsync();
        }
    }

    [Inject] private NavigationManager NavigationManager { get; set; }
    [Inject] private IFlightService FlightService { get; set; }
}
